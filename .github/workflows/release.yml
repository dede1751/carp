name: Release

on:
  push:
    branches: [ "release_ci" ]
    #tags: "v*"

env:
  CARGO_TERM_COLOR: always

jobs:

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Setup Windows toolchain
        run: |
          rustup override set 1.72.0
          rustup target add x86_64-unknown-windows-gnu

      - name: Build Windows binaries
        uses: actions/build_release@v1

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: carp-win
          path: carp-win*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Linux toolchain
        run: |
          rustup override set 1.72.0
          rustup target add x86_64-unknown-linux-gnu
        
      - name: Build Linux binaries
        uses: actions/build_release@v1

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: carp-linux
          path: carp-linux*

  build-macos:
    runs-on: macos-12
    steps:
      - name: Setup MacOS toolchain
        run: |
          rustup override set 1.72.0
          rustup target add x86_64-apple-darwin

      - name: Build MacOS Darwin binaries
        uses: actions/build_release@v1

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: carp-darwin
          path: carp-darwin*

  # This job is largely taken from Velvet: https://github.com/mhonert/velvet-chess
  release:
    if: github.repository == 'dede1751/carp'
    needs: [build-linux, build-windows, build-macos]

    name: Publish Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - uses: actions/download-artifact@v2
        with:
          name: carp-win

      - uses: actions/download-artifact@v2
        with:
          name: carp-linux

      - uses: actions/download-artifact@v2
        with:
          name: carp-darwin

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag_name="${GITHUB_REF##*/}"
          ls -l

          chmod +x carp-linux-x86-64
          chmod +x carp-linux-x86-64-v2
          chmod +x carp-linux-x86-64-v3
          chmod +x carp-linux-x86-64-v4

          mv carp-win-x86-64.exe carp-${tag_name}-win-x86_64-V1.exe
          mv carp-win-x86-64-V2.exe carp-${tag_name}-win-x86_64-V2.exe
          mv carp-win-x86-64-V3.exe carp-${tag_name}-win-x86_64-V3.exe
          mv carp-win-x86-64-V4 carp-${tag_name}-win-x86_64-V4.exe

          mv carp-linux-x86-64 carp-${tag_name}-linux-x86_64-V1
          mv carp-linux-x86-64-V2 carp-${tag_name}-linux-x86_64-V2
          mv carp-linux-x86-64-V3 carp-${tag_name}-linux-x86_64-V3
          mv carp-linux-x86-64-V4 carp-${tag_name}-linux-x86_64-V4

          mv carp-darwin-x86-64 carp-${tag_name}-darwin-x86_64-V1
          mv carp-darwin-x86-64-V2 carp-${tag_name}-darwin-x86_64-V2
          mv carp-darwin-x86-64-V3 carp-${tag_name}-darwin-x86_64-V3
          mv carp-darwin-x86-64-V4 carp-${tag_name}-darwin-x86_64-V4

          sha256sum carp-* > checksums.txt
          echo "$tag_name" > release_description.txt
          cat artifacts/release_notes.md >> release_description.txt

          hub release create --draft \
            -a "checksums.txt#Checksums" \
            -a "carp-${tag_name}-win-x86_64-V4.exe#Carp - Windows (x86_64 - V4)" \
            -a "carp-${tag_name}-win-x86_64-V3.exe#Carp - Windows (x86_64 - V3)" \
            -a "carp-${tag_name}-win-x86_64-v2.exe#Carp - Windows (x86_64 - V2)" \
            -a "carp-${tag_name}-win-x86_64-V1.exe#Carp - Windows (x86_64 - V1)" \
            -a "carp-${tag_name}-linux-x86_64-V4#Carp - Linux (x86_64 - V4)" \
            -a "carp-${tag_name}-linux-x86_64-V3#Carp - Linux (x86_64 - V3)" \
            -a "carp-${tag_name}-linux-x86_64-V2#Carp - Linux (x86_64 - V2)" \
            -a "carp-${tag_name}-linux-x86_64-V1#Carp - Linux (x86_64 - V1)" \
            -a "carp-${tag_name}-darwin-x86_64-V4#Carp - MacOS Darwin (x86_64 - V4)" \
            -a "carp-${tag_name}-darwin-x86_64-V3#Carp - MacOS Darwin (x86_64 - V3)" \
            -a "carp-${tag_name}-darwin-x86_64-V2#Carp - MacOS Darwin (x86_64 - V2)" \
            -a "carp-${tag_name}-darwin-x86_64-V1#Carp - MacOS Darwin (x86_64 - V1)" \
            -F release_description.txt "$tag_name"